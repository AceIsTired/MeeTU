<!DOCTYPE html>
<html>
<head>
    <title>K-Pop Club Portal</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .section { margin: 25px 0; padding: 20px; border: 1px solid #e0e0e0; border-radius: 8px; }
        button { padding: 12px 24px; background: #00c853; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        button:hover { background: #00b248; }
        button:disabled { background: #cccccc; cursor: not-allowed; }
        .result { margin: 15px 0; padding: 12px; border-radius: 4px; min-height: 20px; }
        .success { background: #e8f5e9; border-left: 4px solid #4CAF50; }
        .error { background: #ffebee; border-left: 4px solid #f44336; }
        .info { background: #e3f2fd; border-left: 4px solid #2196F3; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background: #f5f5f5; }
        .user-info { display: flex; align-items: center; gap: 15px; margin: 15px 0; }
        .avatar { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; }
        .loading { display: none; color: #666; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>üéµ K-Pop Club Portal</h1>
    
    <!-- Login Section -->
    <div class="section">
        <h2>GroupMe Login</h2>
        <div id="loginSection">
            <button onclick="startGroupMeLogin()" id="loginBtn">Login with GroupMe</button>
            <div class="loading" id="loginLoading">Starting login...</div>
        </div>
        
        <div id="userSection" style="display: none;">
            <div class="user-info">
                <img id="userAvatar" class="avatar" src="" alt="Avatar">
                <div>
                    <h3 id="userName"></h3>
                    <p id="userEmail"></p>
                </div>
            </div>
            <button onclick="logout()">Logout</button>
            <button onclick="loadUserGroups()" id="groupsBtn">Load My Groups</button>
        </div>
        
        <div class="result" id="loginResult"></div>
        <div id="groupsResult" class="result"></div>
    </div>
    
    <!-- Spreadsheet Data -->
    <div class="section">
        <h2>Club Member Data</h2>
        <div style="margin: 15px 0;">
            <label>Sheet Name: <input type="text" id="sheetName" value="Sheet1" style="padding: 8px;"></label>
            <label style="margin-left: 15px;">Range: <input type="text" id="range" value="A1:E50" style="padding: 8px;"></label>
        </div>
        <button onclick="loadSpreadsheetData()">Load Spreadsheet</button>
        <div class="loading" id="sheetLoading">Loading data...</div>
        <div class="result" id="sheetResult"></div>
        <div id="dataTable" style="display: none;">
            <table>
                <thead id="tableHeader"></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>
    
    <!-- Connection Test -->
    <div class="section">
        <h2>Connection Status</h2>
        <button onclick="testConnection()">Test Server Connection</button>
        <div class="result" id="connectionResult"></div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbyO34PQP-pzofanioVoQ1BEchthqswiThWi-HyrzqeKEBD3uYrmBdLyzqiy_rVUoEXR/exec';
        
        // ============================================
        // OAUTH & TOKEN MANAGEMENT
        // ============================================
        
        // Listen for token from OAuth popup
        window.addEventListener('message', function(event) {
            if (event.data.type === 'groupme_token' && event.data.access_token) {
                const token = event.data.access_token;
                localStorage.setItem('groupme_token', token);
                verifyAndDisplayUser(token);
            }
        });
        
        // Check for existing token on load
        window.addEventListener('DOMContentLoaded', function() {
            const token = localStorage.getItem('groupme_token');
            if (token) {
                verifyAndDisplayUser(token);
            }
            testConnection();
        });
        
        // ============================================
        // MAIN FUNCTIONS
        // ============================================
        
        async function startGroupMeLogin() {
            showLoading('loginLoading', true);
            disableButton('loginBtn', true);
            clearResult('loginResult');
            
            try {
                const result = await callBackend('start_oauth');
                
                if (result.status === 'success') {
                    // Open GroupMe OAuth in popup
                    const width = 600;
                    const height = 700;
                    const left = (window.innerWidth - width) / 2;
                    const top = (window.innerHeight - height) / 2;
                    
                    const popup = window.open(
                        result.auth_url,
                        'GroupMe Login',
                        `width=${width},height=${height},left=${left},top=${top}`
                    );
                    
                    if (!popup) {
                        throw new Error('Popup blocked. Please allow popups for this site.');
                    }
                    
                    showResult('loginResult', '‚úÖ Login popup opened. Please complete the login in the new window.', 'info');
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                showResult('loginResult', '‚ùå ' + error.message, 'error');
            } finally {
                showLoading('loginLoading', false);
                disableButton('loginBtn', false);
            }
        }
        
        async function verifyAndDisplayUser(token) {
            try {
                const result = await callBackend('verify_token', { access_token: token });
                
                if (result.status === 'success') {
                    // Display user info
                    document.getElementById('userName').textContent = result.user.name;
                    document.getElementById('userEmail').textContent = result.user.email || result.user.phone || 'No contact info';
                    
                    if (result.user.avatar_url) {
                        document.getElementById('userAvatar').src = result.user.avatar_url;
                    }
                    
                    // Switch to logged in view
                    document.getElementById('loginSection').style.display = 'none';
                    document.getElementById('userSection').style.display = 'block';
                    
                    showResult('loginResult', '‚úÖ Logged in successfully!', 'success');
                } else {
                    // Invalid token, clear it
                    logout();
                    showResult('loginResult', '‚ùå Session expired. Please login again.', 'error');
                }
            } catch (error) {
                logout();
                showResult('loginResult', '‚ùå Error verifying token: ' + error.message, 'error');
            }
        }
        
        async function loadUserGroups() {
            const token = localStorage.getItem('groupme_token');
            if (!token) {
                showResult('groupsResult', '‚ùå Please login first', 'error');
                return;
            }
            
            disableButton('groupsBtn', true);
            showResult('groupsResult', 'Loading groups...', 'info');
            
            try {
                const result = await callBackend('get_user_groups', { access_token: token });
                
                if (result.status === 'success') {
                    let html = `<h3>Your Groups (${result.groups.length})</h3>`;
                    result.groups.forEach(group => {
                        html += `<div style="margin: 10px 0; padding: 10px; border-bottom: 1px solid #eee;">
                            <strong>${group.name}</strong><br>
                            <small>${group.member_count} members</small>
                        </div>`;
                    });
                    showResult('groupsResult', html, 'success');
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                showResult('groupsResult', '‚ùå ' + error.message, 'error');
            } finally {
                disableButton('groupsBtn', false);
            }
        }
        
        async function loadSpreadsheetData() {
            const sheetName = document.getElementById('sheetName').value.trim() || 'Sheet1';
            const range = document.getElementById('range').value.trim() || 'A1:E50';
            
            showLoading('sheetLoading', true);
            clearResult('sheetResult');
            hideElement('dataTable');
            
            try {
                const result = await callBackend('get_spreadsheet', { 
                    sheet: sheetName, 
                    range: range 
                });
                
                if (result.status === 'success') {
                    showResult('sheetResult', `‚úÖ Loaded ${result.totalRows} rows from "${result.sheet}"`, 'success');
                    displayTable(result.headers, result.data);
                    showElement('dataTable');
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                showResult('sheetResult', '‚ùå ' + error.message, 'error');
            } finally {
                showLoading('sheetLoading', false);
            }
        }
        
        async function testConnection() {
            try {
                const result = await callBackend('test');
                
                if (result.status === 'ok') {
                    showResult('connectionResult', `‚úÖ Server connected: ${result.message}`, 'success');
                } else {
                    showResult('connectionResult', '‚ùå Server error: ' + result.message, 'error');
                }
            } catch (error) {
                showResult('connectionResult', '‚ùå Connection failed: ' + error.message, 'error');
            }
        }
        
        function logout() {
            localStorage.removeItem('groupme_token');
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('userSection').style.display = 'none';
            clearResult('loginResult');
            clearResult('groupsResult');
            showResult('loginResult', 'Logged out successfully.', 'info');
        }
        
        // ============================================
        // BACKEND COMMUNICATION (CORS HANDLING)
        // ============================================
        
        async function callBackend(action, params = {}) {
            // Try JSONP first (works around CORS)
            return await jsonpCall(action, params);
        }
        
        function jsonpCall(action, params = {}) {
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonp_callback_' + Date.now() + '_' + Math.random().toString(36).substr(2);
                
                // Set up callback
                window[callbackName] = function(data) {
                    delete window[callbackName];
                    if (script.parentNode) {
                        script.parentNode.removeChild(script);
                    }
                    resolve(data);
                };
                
                // Build URL
                const url = new URL(BACKEND_URL);
                url.searchParams.append('action', action);
                url.searchParams.append('callback', callbackName);
                
                for (const [key, value] of Object.entries(params)) {
                    if (value !== undefined && value !== null) {
                        url.searchParams.append(key, value);
                    }
                }
                
                // Create script element
                const script = document.createElement('script');
                script.src = url.toString();
                script.onerror = () => {
                    delete window[callbackName];
                    if (script.parentNode) {
                        script.parentNode.removeChild(script);
                    }
                    reject(new Error('JSONP request failed'));
                };
                
                document.body.appendChild(script);
                
                // Timeout after 30 seconds
                setTimeout(() => {
                    if (window[callbackName]) {
                        delete window[callbackName];
                        if (script.parentNode) {
                            script.parentNode.removeChild(script);
                        }
                        reject(new Error('Request timeout'));
                    }
                }, 30000);
            });
        }
        
        // ============================================
        // UI HELPER FUNCTIONS
        // ============================================
        
        function displayTable(headers, data) {
            const tableHeader = document.getElementById('tableHeader');
            const tableBody = document.getElementById('tableBody');
            
            tableHeader.innerHTML = '';
            tableBody.innerHTML = '';
            
            // Create header row
            const headerRow = document.createElement('tr');
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header || 'Column';
                headerRow.appendChild(th);
            });
            tableHeader.appendChild(headerRow);
            
            // Create data rows
            data.forEach(row => {
                const tr = document.createElement('tr');
                headers.forEach(header => {
                    const td = document.createElement('td');
                    td.textContent = row[header] || '';
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });
        }
        
        function showResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = message;
            element.className = 'result ' + (type || 'info');
            element.style.display = 'block';
        }
        
        function clearResult(elementId) {
            const element = document.getElementById(elementId);
            element.innerHTML = '';
            element.style.display = 'none';
        }
        
        function showLoading(elementId, show) {
            document.getElementById(elementId).style.display = show ? 'block' : 'none';
        }
        
        function showElement(elementId) {
            document.getElementById(elementId).style.display = 'block';
        }
        
        function hideElement(elementId) {
            document.getElementById(elementId).style.display = 'none';
        }
        
        function disableButton(buttonId, disabled) {
            const button = document.getElementById(buttonId);
            if (button) {
                button.disabled = disabled;
                button.style.opacity = disabled ? '0.6' : '1';
            }
        }
    </script>
</body>
</html>